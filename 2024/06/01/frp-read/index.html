<!DOCTYPE html>
<html lang=zh>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="frp æ˜¯ä¸€æ¬¾ä¸“æ³¨äºå†…ç½‘ç©¿é€çš„ã€é«˜æ€§èƒ½çš„åå‘ä»£ç†å·¥å…·ï¼Œåš Web å®‰å…¨ä»¥åŠç½‘ç»œå¼€å‘æ—¶å¸¸ç”¨ã€‚å°±ç®—ä½ æ²¡æ¥è§¦è¿‡è¿™äº›é¢†åŸŸï¼Œå®¤å‹å¼€é»‘æ‰“æ¸¸æˆæ—¶ï¼Œä¹Ÿå¯èƒ½ä¼šä½¿ç”¨ Sakura FRP åšå†…ç½‘ç©¿é€å®ç°å±€åŸŸç½‘è”æœºã€‚ v0.1.0 ç‰ˆæœ¬v0.1.0 ç‰ˆæœ¬çš„ä»£ç é‡å¾ˆå°ï¼Œæ ¸å¿ƒåŠŸèƒ½ä»£ç å°± 1079 è¡Œï¼Œé¡¹ç›®ç»“æ„ä¹Ÿå¾ˆç®€å•ï¼Œé€‚åˆä¸Šæ‰‹ã€‚ 12345678910111213141516171819PROJECT:â””â”€frp    â”œ">
<meta property="og:type" content="article">
<meta property="og:title" content="FRPv0.1.0 æºç é˜…è¯»">
<meta property="og:url" content="https://blog.kinoko.fun/2024/06/01/frp-read/index.html">
<meta property="og:site_name" content="é˜¿è‡ã®åšå®¢">
<meta property="og:description" content="frp æ˜¯ä¸€æ¬¾ä¸“æ³¨äºå†…ç½‘ç©¿é€çš„ã€é«˜æ€§èƒ½çš„åå‘ä»£ç†å·¥å…·ï¼Œåš Web å®‰å…¨ä»¥åŠç½‘ç»œå¼€å‘æ—¶å¸¸ç”¨ã€‚å°±ç®—ä½ æ²¡æ¥è§¦è¿‡è¿™äº›é¢†åŸŸï¼Œå®¤å‹å¼€é»‘æ‰“æ¸¸æˆæ—¶ï¼Œä¹Ÿå¯èƒ½ä¼šä½¿ç”¨ Sakura FRP åšå†…ç½‘ç©¿é€å®ç°å±€åŸŸç½‘è”æœºã€‚ v0.1.0 ç‰ˆæœ¬v0.1.0 ç‰ˆæœ¬çš„ä»£ç é‡å¾ˆå°ï¼Œæ ¸å¿ƒåŠŸèƒ½ä»£ç å°± 1079 è¡Œï¼Œé¡¹ç›®ç»“æ„ä¹Ÿå¾ˆç®€å•ï¼Œé€‚åˆä¸Šæ‰‹ã€‚ 12345678910111213141516171819PROJECT:â””â”€frp    â”œ">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2024-05-31T16:00:00.000Z">
<meta property="article:modified_time" content="2025-01-02T07:21:22.221Z">
<meta property="article:author" content="é˜¿è‡kinoko">
<meta property="article:tag" content="ma5hr00m,kinoko,é˜¿è‡kinoko,blog,åšå®¢,åšæ–‡">
<meta name="twitter:card" content="summary">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>FRPv0.1.0 æºç é˜…è¯»</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
      <link rel="alternate" href="/true" title="é˜¿è‡ã®åšå®¢" type="application/atom+xml" />
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 7.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="ç›®å½•"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="ç›®å½•"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="é¡¶éƒ¨" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">ğŸ“„é¦–é¡µ</a></li><!--
     --><!--
       --><li><a href="/archives/">ğŸ“‚å½’æ¡£</a></li><!--
     --><!--
       --><li><a href="/friends/">ğŸ‘«å‹é“¾</a></li><!--
     --><!--
       --><li><a href="/categories/">ğŸ—‚ï¸åˆ†ç±»</a></li><!--
     --><!--
       --><li><a href="/tags/">ğŸ·ï¸æ ‡ç­¾</a></li><!--
     --><!--
       --><li><a href="/about/">ğŸŒ¸å…³äº</a></li><!--
     --><!--
       --><li><a href="/log/">ğŸ“–æ—¥å¿—</a></li><!--
     --><!--
       --><li><a href="/search/">ğŸ”æœç´¢</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="ä¸Šä¸€ç¯‡" href="/2024/06/03/async-await/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="ä¸‹ä¸€ç¯‡" href="/2024/05/21/hello-web/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="è¿”å›é¡¶éƒ¨" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="åˆ†äº«æ–‡ç« " href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">ä¸Šä¸€ç¯‡</span>
      <span id="i-next" class="info" style="display:none;">ä¸‹ä¸€ç¯‡</span>
      <span id="i-top" class="info" style="display:none;">è¿”å›é¡¶éƒ¨</span>
      <span id="i-share" class="info" style="display:none;">åˆ†äº«æ–‡ç« </span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://blog.kinoko.fun/2024/06/01/frp-read/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://blog.kinoko.fun/2024/06/01/frp-read/&text=FRPv0.1.0 æºç é˜…è¯»"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://blog.kinoko.fun/2024/06/01/frp-read/&title=FRPv0.1.0 æºç é˜…è¯»"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://blog.kinoko.fun/2024/06/01/frp-read/&is_video=false&description=FRPv0.1.0 æºç é˜…è¯»"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=FRPv0.1.0 æºç é˜…è¯»&body=Check out this article: https://blog.kinoko.fun/2024/06/01/frp-read/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://blog.kinoko.fun/2024/06/01/frp-read/&title=FRPv0.1.0 æºç é˜…è¯»"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://blog.kinoko.fun/2024/06/01/frp-read/&title=FRPv0.1.0 æºç é˜…è¯»"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://blog.kinoko.fun/2024/06/01/frp-read/&title=FRPv0.1.0 æºç é˜…è¯»"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://blog.kinoko.fun/2024/06/01/frp-read/&title=FRPv0.1.0 æºç é˜…è¯»"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://blog.kinoko.fun/2024/06/01/frp-read/&name=FRPv0.1.0 æºç é˜…è¯»&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://blog.kinoko.fun/2024/06/01/frp-read/&t=FRPv0.1.0 æºç é˜…è¯»"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#v0-1-0-%E7%89%88%E6%9C%AC"><span class="toc-number">1.</span> <span class="toc-text">v0.1.0 ç‰ˆæœ¬</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#frps"><span class="toc-number">1.1.</span> <span class="toc-text">frps</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#frpc"><span class="toc-number">1.2.</span> <span class="toc-text">frpc</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%8E%E8%AF%9D"><span class="toc-number">2.</span> <span class="toc-text">åè¯</span></a></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        FRPv0.1.0 æºç é˜…è¯»
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">é˜¿è‡kinoko</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2024-05-31T16:00:00.000Z" class="dt-published" itemprop="datePublished">2024-06-01</time>
        
        (Updated: <time datetime="2025-01-02T07:21:22.221Z" class="dt-updated" itemprop="dateModified">2025-01-02</time>)
        
      
    </div>


      
    <div class="article-category">
        <i class="fa-solid fa-archive"></i>
        <a class="category-link" href="/categories/FRP/">FRP</a>
    </div>


      

    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <p>frp æ˜¯ä¸€æ¬¾ä¸“æ³¨äºå†…ç½‘ç©¿é€çš„ã€é«˜æ€§èƒ½çš„åå‘ä»£ç†å·¥å…·ï¼Œåš Web å®‰å…¨ä»¥åŠç½‘ç»œå¼€å‘æ—¶å¸¸ç”¨ã€‚å°±ç®—ä½ æ²¡æ¥è§¦è¿‡è¿™äº›é¢†åŸŸï¼Œå®¤å‹å¼€é»‘æ‰“æ¸¸æˆæ—¶ï¼Œä¹Ÿå¯èƒ½ä¼šä½¿ç”¨ <a target="_blank" rel="noopener" href="https://www.natfrp.com/">Sakura FRP</a> åšå†…ç½‘ç©¿é€å®ç°å±€åŸŸç½‘è”æœºã€‚</p>
<h2 id="v0-1-0-ç‰ˆæœ¬"><a href="#v0-1-0-ç‰ˆæœ¬" class="headerlink" title="v0.1.0 ç‰ˆæœ¬"></a>v0.1.0 ç‰ˆæœ¬</h2><p>v0.1.0 ç‰ˆæœ¬çš„ä»£ç é‡å¾ˆå°ï¼Œæ ¸å¿ƒåŠŸèƒ½ä»£ç å°± 1079 è¡Œï¼Œé¡¹ç›®ç»“æ„ä¹Ÿå¾ˆç®€å•ï¼Œé€‚åˆä¸Šæ‰‹ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">PROJECT:</span><br><span class="line">â””â”€frp</span><br><span class="line">    â”œâ”€conf</span><br><span class="line">    â”œâ”€Godeps       </span><br><span class="line">    â””â”€src</span><br><span class="line">        â””â”€frp</span><br><span class="line">            â”œâ”€cmd</span><br><span class="line">            â”‚  â”œâ”€frpc</span><br><span class="line">            â”‚  â””â”€frps</span><br><span class="line">            â”œâ”€models</span><br><span class="line">            â”‚  â”œâ”€client | å®¢æˆ·ç«¯é…ç½®ä¿¡æ¯ &amp; </span><br><span class="line">            â”‚  â”œâ”€consts</span><br><span class="line">            â”‚  â”œâ”€msg | å®šä¹‰è¯·æ±‚/å“åº”ä¿¡æ¯çš„ç»“æ„ä½“</span><br><span class="line">            â”‚  â””â”€server | æœåŠ¡ç«¯é…ç½®ä¿¡æ¯ &amp; å¤„ç†ä»£ç†æœåŠ¡å™¨çš„å‡½æ•°</span><br><span class="line">            â””â”€utils</span><br><span class="line">                â”œâ”€broadcast | </span><br><span class="line">                â”œâ”€conn | è®¾ç½®æœ¬åœ°ç›‘å¬å™¨ &amp; è·å–/å‘èµ·è¿æ¥çš„å‡½æ•°</span><br><span class="line">                â”œâ”€<span class="built_in">log</span> | æ—¥å¿—å¤„ç†</span><br><span class="line">                â””â”€pcrypto</span><br></pre></td></tr></table></figure>

<p>åœ¨å¼€å§‹ä¹‹å‰ï¼Œå…ˆäº†è§£ Godepsï¼Œä¸€ä¸ªæ—§æ—¶ä»£çš„åŒ…ä¾èµ–ç®¡ç†å·¥å…·ï¼ŒåŸç†æ˜¯æ‰«æè®°å½•ç‰ˆæœ¬æ§åˆ¶çš„ä¿¡æ¯ï¼Œå¹¶åœ¨ go å‘½ä»¤å‰åŠ å£³ä»¥å®ç°ä¾èµ–ç®¡ç†ã€‚ä¸è¿‡åæ¥é€æ¸è¢«å¤§å®¶æ›´ä¸ºç†ŸçŸ¥çš„ <code>go mod</code> å–ä»£äº†ï¼Œå…¶ GitHub ä»“åº“ä¹Ÿè¢« archive äº†ã€‚</p>
<p>é¡¹ç›®ä¸­ä½¿ç”¨è¯¥å·¥å…·ç®¡ç† Go ä¾èµ–åº“æ—¶ï¼Œä¼šåœ¨é¡¹ç›®ä¸­ç”Ÿæˆ <code>/Godeps/Godeps.json</code> é…ç½®æ–‡ä»¶ã€‚è¿™é‡Œå°±ä¸åœ¨è§£é‡Šäº†ï¼Œè‡ªå·±çœ‹çœ‹å°±å¯ä»¥ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="string">&quot;ImportPath&quot;</span>: <span class="string">&quot;frp&quot;</span>,</span><br><span class="line">	<span class="string">&quot;GoVersion&quot;</span>: <span class="string">&quot;go1.4&quot;</span>,</span><br><span class="line">	<span class="string">&quot;Packages&quot;</span>: [</span><br><span class="line">		<span class="string">&quot;./...&quot;</span></span><br><span class="line">	],</span><br><span class="line">	<span class="string">&quot;Deps&quot;</span>: [</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="string">&quot;ImportPath&quot;</span>: <span class="string">&quot;github.com/astaxie/beego/logs&quot;</span>,</span><br><span class="line">			<span class="string">&quot;Comment&quot;</span>: <span class="string">&quot;v1.5.0-9-gfb7314f&quot;</span>,</span><br><span class="line">			<span class="string">&quot;Rev&quot;</span>: <span class="string">&quot;fb7314f8ac86b83ccd34386518d97cf2363e2ae5&quot;</span></span><br><span class="line">		&#125;,</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="string">&quot;ImportPath&quot;</span>: <span class="string">&quot;github.com/vaughan0/go-ini&quot;</span>,</span><br><span class="line">			<span class="string">&quot;Rev&quot;</span>: <span class="string">&quot;a98ad7ee00ec53921f08832bc06ecf7fd600e6a1&quot;</span></span><br><span class="line">		&#125;</span><br><span class="line">	]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>frp åˆ†å®¢æˆ·ç«¯ï¼ˆfrpcï¼‰å’ŒæœåŠ¡ç«¯ï¼ˆfrpsï¼‰ï¼Œä½¿ç”¨æ—¶æ˜¯å…ˆå»ºç«‹æœåŠ¡ç«¯å†å»ºç«‹å®¢æˆ·ç«¯ï¼Œå°±æŒ‰ç…§è¿™ä¸ªé¡ºåºã€‚</p>
<h3 id="frps"><a href="#frps" class="headerlink" title="frps"></a>frps</h3><p>å¯¹åº”çš„é…ç½®æ–‡ä»¶å¦‚ä¸‹ï¼š</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[common]</span></span><br><span class="line"><span class="attr">bind_addr</span> = <span class="number">0.0</span>.<span class="number">0.0</span></span><br><span class="line"><span class="attr">bind_port</span> = <span class="number">7000</span></span><br><span class="line"><span class="attr">log_file</span> = ./frps.log</span><br><span class="line"><span class="comment"># debug, info, warn, error</span></span><br><span class="line"><span class="attr">log_level</span> = debug</span><br><span class="line"><span class="comment"># file, console</span></span><br><span class="line"><span class="attr">log_way</span> = console </span><br><span class="line"></span><br><span class="line"><span class="section">[test1]</span></span><br><span class="line"><span class="attr">passwd</span> = <span class="number">123</span></span><br><span class="line"><span class="attr">bind_addr</span> = <span class="number">0.0</span>.<span class="number">0.0</span></span><br><span class="line"><span class="attr">listen_port</span> = <span class="number">6000</span></span><br></pre></td></tr></table></figure>

<p>å…ˆçœ‹é¡¹ç›®å…¥å£æ–‡ä»¶ï¼Œä½ç½®æ˜¯ <code>src/frp/cmd/frps/main.go</code>ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	err := server.LoadConf(<span class="string">&quot;./frps.ini&quot;</span>)</span><br><span class="line">	<span class="comment">// ... ...</span></span><br><span class="line">	</span><br><span class="line">	log.InitLog(server.LogWay, server.LogFile, server.LogLevel)</span><br><span class="line">	</span><br><span class="line">	l, err := conn.Listen(server.BindAddr, server.BindPort)</span><br><span class="line">	<span class="comment">// ... ...</span></span><br><span class="line">	</span><br><span class="line">	log.Info(<span class="string">&quot;Start frps success&quot;</span>)</span><br><span class="line">	ProcessControlConn(l)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è°ƒç”¨ <code>src/frp/models/server/config.go</code> ä¸­çš„ <code>LoadConf</code> æ–¹æ³•åŠ è½½é…ç½®æ–‡ä»¶ï¼›åˆå§‹åŒ–æ—¥å¿—è®°å½•ï¼Œä½¿ç”¨ server åŒ…ä¸­å®šä¹‰çš„æ—¥å¿—è®°å½•æ–¹å¼ã€æ—¥å¿—æ–‡ä»¶å’Œæ—¥å¿—çº§åˆ«ï¼›å»ºç«‹è¿æ¥ï¼›åœ¨å‰é¢æ— è¯¯çš„æƒ…å†µä¸‹æ‰“å° success ä¿¡æ¯ï¼›æœ€åè°ƒç”¨ <code>ProcessControlConn</code> å‡½æ•°ï¼Œå¤„ç†æ§åˆ¶è¿æ¥ã€‚</p>
<p>ç„¶åçœ‹ <code>src/frp/models/server/config.go</code>ã€‚</p>
<p>è¿™ä¸ªæ–‡ä»¶çš„åŠŸèƒ½å°±æ˜¯ä½¿ç”¨ <code>github.com/vaughan0/go-ini</code> åº“å°†é…ç½®æ–‡ä»¶ä¿¡æ¯æ˜ å°„ä¸ºç»“æ„ä½“ï¼Œæ–¹ä¾¿åç»­ä½¿ç”¨ã€‚é…ç½®æ–‡ä»¶å¯åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œ<code>[common]</code> é€šç”¨ä¿¡æ¯å’Œä»£ç†æœåŠ¡å™¨ä¿¡æ¯åˆ—è¡¨ï¼Œå…¶ä¸­ <code>[common]</code> å¦‚æœæ²¡åœ¨é…ç½®æ–‡ä»¶ä¸­æŒ‡å®šï¼Œå°±æ˜¯ç”¨è¯¥æ–‡ä»¶å¼€å¤´æŒ‡å®šçš„é»˜è®¤å€¼ã€‚å…¶ä»–é…ç½®ä¿¡æ¯éƒ½è¢«å½“åšä»£ç†æœåŠ¡å™¨ä¿¡æ¯å¾ªç¯è¯»å–ï¼Œæ–‡ä»¶å¼€å¤´åˆå§‹åŒ–äº†ä¸€ä¸ª <code>ProxyServers</code>  æ˜ å°„ï¼Œç”¨äºå­˜å‚¨ä»£ç†æœåŠ¡å™¨çš„é…ç½®ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ProxyServers <span class="keyword">map</span>[<span class="type">string</span>]*ProxyServer = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]*ProxyServer)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">LoadConf</span><span class="params">(confFile <span class="type">string</span>)</span></span> (err <span class="type">error</span>) &#123;</span><br><span class="line">	<span class="comment">// ... ...</span></span><br><span class="line">	<span class="keyword">for</span> name, section := <span class="keyword">range</span> conf &#123;</span><br><span class="line">		<span class="keyword">if</span> name != <span class="string">&quot;common&quot;</span> &#123;</span><br><span class="line">			proxyServer := &amp;ProxyServer&#123;&#125;</span><br><span class="line">			proxyServer.Name = name</span><br><span class="line"></span><br><span class="line">			proxyServer.Passwd, ok = section[<span class="string">&quot;passwd&quot;</span>]</span><br><span class="line">			<span class="keyword">if</span> !ok &#123;</span><br><span class="line">				<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;Parse ini file error: proxy [%s] no passwd found&quot;</span>, proxyServer.Name)</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			proxyServer.BindAddr, ok = section[<span class="string">&quot;bind_addr&quot;</span>]</span><br><span class="line">			<span class="keyword">if</span> !ok &#123;</span><br><span class="line">				proxyServer.BindAddr = <span class="string">&quot;0.0.0.0&quot;</span></span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			portStr, ok := section[<span class="string">&quot;listen_port&quot;</span>]</span><br><span class="line">			<span class="keyword">if</span> ok &#123;</span><br><span class="line">				proxyServer.ListenPort, err = strconv.ParseInt(portStr, <span class="number">10</span>, <span class="number">64</span>)</span><br><span class="line">				<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">					<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;Parse ini file error: proxy [%s] listen_port error&quot;</span>, proxyServer.Name)</span><br><span class="line">				&#125;</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;Parse ini file error: proxy [%s] listen_port not found&quot;</span>, proxyServer.Name)</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			proxyServer.Init()</span><br><span class="line">			ProxyServers[proxyServer.Name] = proxyServer</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// è¦æ±‚è‡³å°‘æœ‰ä¸€ä¸ªä»£ç†æœåŠ¡å™¨é…ç½®é€‰é¡¹ï¼Œå¦‚æœæ²¡æœ‰å°±æç¤ºè§£æé”™è¯¯</span></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(ProxyServers) == <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;Parse ini file error: no proxy config found&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// ... ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ—¥å¿—éƒ¨åˆ†ä½¿ç”¨çš„æ˜¯ <code>github.com/astaxie/beego/logs</code> ä¸‰æ–¹åº“ã€‚å¯ä»¥ä¸ç»†çœ‹ï¼Œæ—¥å¿—éƒ¨åˆ†æ‰€éœ€çš„é…ç½®ä¿¡æ¯ç”±ä¸Šé¢æ‰€è¯´çš„é…ç½®æ–‡ä»¶æŒ‡å®šçš„ã€‚</p>
<p>å†çœ‹ <code>src/frp/utils/conn/conn.go</code>ï¼Œè¿™éƒ¨åˆ†åŠŸèƒ½æ˜¯å®ç°æœåŠ¡ç«¯ä¸å®¢æˆ·ç«¯çš„è¿æ¥ã€‚</p>
<p>æ–‡ä»¶å¼€å¤´å®šä¹‰äº†ä¸€ä¸ª <code>Listener</code> ç»“æ„ä½“ï¼Œç”¨äºå­˜å‚¨ TCP ç›‘å¬å™¨çš„åœ°å€ã€ç›‘å¬å™¨å¯¹è±¡ã€è¿æ¥é€šé“å’Œå…³é—­æ ‡å¿—ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Listener <span class="keyword">struct</span> &#123;</span><br><span class="line">	addr      net.Addr</span><br><span class="line">	l         *net.TCPListener</span><br><span class="line">	conns     <span class="keyword">chan</span> *Conn</span><br><span class="line">	closeFlag <span class="type">bool</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>Listen</code> å‡½æ•°ç”¨äºåœ¨æŒ‡å®šç«¯å£å¯åŠ¨ä¸€ä¸ª TCP ç›‘å¬å™¨ï¼Œæ¥å—ç»‘å®šçš„åœ°å€å’Œç«¯å£å·ä½œä¸ºå‚æ•°ï¼ˆé…ç½®æ–‡ä»¶ä¸­æŒ‡å®šï¼‰ï¼Œå¹¶è¿”å›ä¸€ä¸ª <code>Listener</code> å¯¹è±¡ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Listen</span><span class="params">(bindAddr <span class="type">string</span>, bindPort <span class="type">int64</span>)</span></span> (l *Listener, err <span class="type">error</span>) &#123;</span><br><span class="line">	<span class="comment">// è§£æTCPåœ°å€ï¼ŒæŒ‡å®š tcp4</span></span><br><span class="line">	tcpAddr, err := net.ResolveTCPAddr(<span class="string">&quot;tcp4&quot;</span>, fmt.Sprintf(<span class="string">&quot;%s:%d&quot;</span>, bindAddr, bindPort))</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> l, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// åœ¨è§£æçš„TCPåœ°å€ä¸Šå¼€å§‹ç›‘å¬</span></span><br><span class="line">	listener, err := net.ListenTCP(<span class="string">&quot;tcp&quot;</span>, tcpAddr)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> l, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ä½¿ç”¨ç›‘å¬å™¨çš„åœ°å€ã€ç›‘å¬å™¨å¯¹è±¡ã€è¿æ¥é€šé“å’Œå…³é—­æ ‡å¿—åˆå§‹åŒ– Listener ç»“æ„ä½“</span></span><br><span class="line">	l = &amp;Listener&#123;</span><br><span class="line">		addr:      listener.Addr(),</span><br><span class="line">		l:         listener,</span><br><span class="line">		conns:     <span class="built_in">make</span>(<span class="keyword">chan</span> *Conn),</span><br><span class="line">		closeFlag: <span class="literal">false</span>,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// å¯åŠ¨ä¸€ä¸ªåç¨‹æ¥æ¥å—æ–°çš„è¿æ¥</span></span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">for</span> &#123;</span><br><span class="line">			<span class="comment">// æ¥å—æ–°çš„TCPè¿æ¥</span></span><br><span class="line">			conn, err := l.l.AcceptTCP()</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="comment">// å¦‚æœç›‘å¬å™¨å·²ç»å…³é—­ï¼Œåˆ™è¿”å›ç»“æŸåç¨‹</span></span><br><span class="line">				<span class="keyword">if</span> l.closeFlag &#123;</span><br><span class="line">					<span class="keyword">return</span></span><br><span class="line">				&#125;</span><br><span class="line">				<span class="comment">// å¦‚æœæ˜¯å…¶ä»–é”™è¯¯ï¼Œåˆ™å¿½ç•¥å¹¶ç»§ç»­ç­‰å¾…æ–°çš„è¿æ¥</span></span><br><span class="line">				<span class="keyword">continue</span></span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// ä¸ºæ¯ä¸ªæ¥å—çš„è¿æ¥åˆ›å»ºä¸€ä¸ª Conn å®ä¾‹ï¼Œå¹¶å°†å…¶å‘é€åˆ° Listener çš„è¿æ¥é€šé“ä¸­</span></span><br><span class="line">			c := &amp;Conn&#123;</span><br><span class="line">				TcpConn:   conn,</span><br><span class="line">				closeFlag: <span class="literal">false</span>,</span><br><span class="line">			&#125;</span><br><span class="line">			c.Reader = bufio.NewReader(c.TcpConn)</span><br><span class="line">			l.conns &lt;- c</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;()</span><br><span class="line">	<span class="keyword">return</span> l, err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿”å›çš„ <code>Listener</code> æ˜¯ä¸€ä¸ªå‡†å¤‡å¥½æ¥å—è¿æ¥çš„ç»“æ„ä½“ã€‚è¿™ä¸ªç»“æ„ä½“åŒ…å«äº†ä¸€ä¸ªé€šé“ï¼ˆ<code>conns</code>ï¼‰ï¼Œç”¨äºæ¥æ”¶å’Œå­˜å‚¨æ–°çš„è¿æ¥ã€‚åœ¨ <code>Listen</code> å‡½æ•°å†…éƒ¨ï¼Œæœ‰ä¸€ä¸ªåç¨‹ä¸æ–­åœ°æ¥å—æ–°çš„è¿æ¥å¹¶å°†å®ƒä»¬æ”¾å…¥è¿™ä¸ªé€šé“ã€‚</p>
<p>æˆ‘ä»¬çš„ç›®å…‰å†è¿”å›ä¸»å‡½æ•°ã€‚ä¸»å‡½æ•°å»ºç«‹å¥½ä¸Šæ–‡è¯´çš„è¿™ä¸ª <code>l</code> åï¼Œå°±è®¤ä¸º frp å·²ç»æˆåŠŸå¯åŠ¨äº†ï¼Œç„¶åå°†è¿™ä¸ª <code>l</code> ä¼ é€’ç»™æ§åˆ¶æ¨¡å—è¿›è¡Œç®¡ç†ï¼Œæ§åˆ¶æ¨¡å—ä¸»ä½“åœ¨ <code>src/frp/cmd/frps/control.go</code> ä¸­ã€‚</p>
<p><code>ProcessControlConn</code> å‡½æ•°å¯åŠ¨ä¸€ä¸ªæ— é™å¾ªç¯ï¼Œè°ƒç”¨ <code>l.GetConn()</code> æ–¹æ³•å°è¯•ä»ç›‘å¬å™¨è·å–ä¸€ä¸ªæ–°çš„è¿æ¥å¯¹è±¡ <code>c</code> ï¼šå¦‚æœæˆåŠŸè·å–åˆ°æ–°çš„è¿æ¥ï¼Œå®ƒå°†ä¸ºæ¯ä¸ªæ–°çš„è¿æ¥å¯åŠ¨ä¸€ä¸ªæ–°çš„åç¨‹ <code>controlWorker(c)</code>ï¼Œè¿™ä¸ªåç¨‹å°†ç‹¬ç«‹å¤„ç†æ¯ä¸ªè¿æ¥çš„æ§åˆ¶é€»è¾‘ï¼›å¦‚æœ <code>l.GetConn()</code> è¿”å›é”™è¯¯ï¼Œå‡½æ•°å°†åœæ­¢è¿è¡Œã€‚</p>
<p>è¿™é‡Œçš„è¿æ¥å¯¹è±¡ <code>c</code> åœ¨é¡¹ç›®çš„ <code>utils/conn</code> ä¸­å®šä¹‰ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Conn <span class="keyword">struct</span> &#123;</span><br><span class="line">	TcpConn   *net.TCPConn</span><br><span class="line">	Reader    *bufio.Reader</span><br><span class="line">	closeFlag <span class="type">bool</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>Conn</code> ç»“æ„ä½“æ˜¯ä¸€ä¸ªè‡ªå®šä¹‰çš„æ•°æ®ç±»å‹ï¼Œç”¨äºå°è£… TCP è¿æ¥åŠå…¶ç›¸å…³æ“ä½œï¼š</p>
<ul>
<li><code>TcpConn</code>ï¼šæŒ‡å‘ <code>net.TCPConn</code> çš„æŒ‡é’ˆï¼Œå®ƒä»£è¡¨äº†åº•å±‚çš„ TCP è¿æ¥ã€‚é€šè¿‡è¿™ä¸ªå­—æ®µï¼Œå¯ä»¥è®¿é—®å’Œæ§åˆ¶ TCP ç½‘ç»œè¿æ¥çš„å„ç§å±æ€§å’Œæ–¹æ³•ï¼Œå¦‚å‘é€å’Œæ¥æ”¶æ•°æ®ã€‚</li>
<li><code>Reader</code>ï¼šæŒ‡å‘ <code>bufio.Reader</code> çš„æŒ‡é’ˆï¼Œå®ƒæä¾›äº†ä¸€ä¸ªç¼“å†²åŒºï¼Œå¯ä»¥æ›´é«˜æ•ˆåœ°è¯»å–æ•°æ®ã€‚è¿™ä¸ªè¯»å–å™¨å°è£…äº† <code>TcpConn</code>ï¼Œä½¿å¾—å¯ä»¥æ–¹ä¾¿åœ°è¿›è¡Œå¦‚æŒ‰è¡Œè¯»å–æ–‡æœ¬ç­‰æ“ä½œã€‚</li>
<li><code>closeFlag</code>ï¼šå¸ƒå°”å€¼ï¼Œç”¨äºæŒ‡ç¤ºè¿æ¥æ˜¯å¦å·²ç»è¢«å…³é—­ã€‚å¦‚æœä¸º <code>true</code>ï¼Œåˆ™è¡¨ç¤ºè¿æ¥å·²ç»å…³é—­ï¼Œä¸åº”å†è¿›è¡Œè¯»å†™æ“ä½œã€‚</li>
</ul>
<p>ç„¶åå†çœ‹ç”¨äºå¤„ç†è¿æ¥çš„å‡½æ•° <code>controlWorker(c)</code>ï¼Œå…¶ä¸­æœ‰ä¸¤ä¸ªè¾ƒä¸ºå…³é”®çš„å‡½æ•°ï¼Œå‡åœ¨æ³¨é‡Šä¸­æ ‡æ³¨äº† <code>â˜…</code>ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">controlWorker</span><span class="params">(c *conn.Conn)</span></span> &#123;</span><br><span class="line">	<span class="comment">// é¦–æ¡æ¶ˆæ¯æ˜¯ä»å®¢æˆ·ç«¯å‘å¾€æœåŠ¡å™¨çš„ï¼Œå¦‚æœå‡ºé”™åˆ™å…³é—­è¿æ¥ã€‚</span></span><br><span class="line">	res, err := c.ReadLine()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Warn(<span class="string">&quot;Read error, %v&quot;</span>, err)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// è¯»å–æˆåŠŸåˆ™ç»§ç»­è°ƒè¯•ä¿¡æ¯ï¼Œæ‰“å°è¿”å›çš„æ¶ˆæ¯</span></span><br><span class="line">	log.Debug(<span class="string">&quot;get: %s&quot;</span>, res)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// å°†è¯»å–åˆ°çš„ä¿¡æ¯ååºåˆ—åŒ–ä¸º ClientCtlReq ç»“æ„ä½“</span></span><br><span class="line">	clientCtlReq := &amp;msg.ClientCtlReq&#123;&#125;</span><br><span class="line">	clientCtlRes := &amp;msg.ClientCtlRes&#123;&#125;</span><br><span class="line">	<span class="keyword">if</span> err := json.Unmarshal([]<span class="type">byte</span>(res), &amp;clientCtlReq); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Warn(<span class="string">&quot;Parse err: %v : %s&quot;</span>, err, res)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// â˜… æ£€æŸ¥ä»£ç†é…ç½®æ˜¯å¦æ­£ç¡®</span></span><br><span class="line">	succ, info, needRes := checkProxy(clientCtlReq, c)</span><br><span class="line">	<span class="keyword">if</span> !succ &#123;</span><br><span class="line">		clientCtlRes.Code = <span class="number">1</span></span><br><span class="line">		clientCtlRes.Msg = info</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> needRes &#123;</span><br><span class="line">		<span class="comment">// å¦‚æœéœ€è¦å“åº”å®¢æˆ·ç«¯ï¼Œåˆ™åœ¨å‡½æ•°ç»“æŸå‰å…³é—­è¿æ¥</span></span><br><span class="line">		<span class="keyword">defer</span> c.Close()</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// å°†å“åº”æ¶ˆæ¯åºåˆ—åŒ–å¹¶å†™å…¥è¿æ¥</span></span><br><span class="line">		buf, _ := json.Marshal(clientCtlRes)</span><br><span class="line">		err = c.Write(<span class="type">string</span>(buf) + <span class="string">&quot;\\n&quot;</span>)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Warn(<span class="string">&quot;Write error, %v&quot;</span>, err)</span><br><span class="line">			time.Sleep(<span class="number">1</span> * time.Second)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// æ£€æŸ¥ä»£ç†è¿æ¥æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">	s, ok := server.ProxyServers[clientCtlReq.ProxyName]</span><br><span class="line">	<span class="keyword">if</span> !ok &#123;</span><br><span class="line">		log.Warn(<span class="string">&quot;ProxyName [%s] is not exist&quot;</span>, clientCtlReq.ProxyName)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// â˜… å¯åŠ¨ä¸€ä¸ªæ–°çš„åç¨‹ï¼Œç”¨äºè¯»å–å®¢æˆ·ç«¯å‘é€çš„æ§åˆ¶ä¿¡æ¯</span></span><br><span class="line">	<span class="keyword">go</span> readControlMsgFromClient(s, c)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// åˆ›å»ºä¸€ä¸ªæ–°çš„ ClientCtlReq ç»“æ„ä½“ï¼Œå¹¶è®¾ç½®ç±»å‹ä¸ºå·¥ä½œè¿æ¥</span></span><br><span class="line">	serverCtlReq := &amp;msg.ClientCtlReq&#123;&#125;</span><br><span class="line">	serverCtlReq.Type = consts.WorkConn</span><br><span class="line">	<span class="comment">// è¿›å…¥ä¸€ä¸ªå¾ªç¯ï¼Œç­‰å¾…ç”¨æˆ·è¿æ¥ï¼Œå¦‚æœä»£ç†æœåŠ¡å™¨å…³é—­ï¼Œè®°å½•è°ƒè¯•ä¿¡æ¯å¹¶é€€å‡ºå¾ªç¯</span></span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		closeFlag := s.WaitUserConn()</span><br><span class="line">		<span class="keyword">if</span> closeFlag &#123;</span><br><span class="line">			log.Debug(<span class="string">&quot;ProxyName [%s], goroutine for dealing user conn is closed&quot;</span>, s.Name)</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// åºåˆ—åŒ–æœåŠ¡å™¨æ§åˆ¶è¯·æ±‚å¹¶å†™å…¥è¿æ¥ã€‚å¦‚æœå†™å…¥å¤±è´¥ï¼Œè®°å½•è­¦å‘Šï¼Œå…³é—­ä»£ç†æœåŠ¡å™¨å¹¶è¿”å›</span></span><br><span class="line">		buf, _ := json.Marshal(serverCtlReq)</span><br><span class="line">		err = c.Write(<span class="type">string</span>(buf) + <span class="string">&quot;\\n&quot;</span>)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Warn(<span class="string">&quot;ProxyName [%s], write to client error, proxy exit&quot;</span>, s.Name)</span><br><span class="line">			s.Close()</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		log.Debug(<span class="string">&quot;ProxyName [%s], write to client to add work conn success&quot;</span>, s.Name)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	log.Info(<span class="string">&quot;ProxyName [%s], I&#x27;m dead!&quot;</span>, s.Name)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><code>checkProxy</code> å‡½æ•°é¦–å…ˆæ£€éªŒä»£ç†æ˜¯å¦åˆæ³•ï¼Œç„¶åé€šè¿‡æ£€æŸ¥ <code>req.Type</code> çš„å€¼æ¥åŒºåˆ†æ§åˆ¶è¿æ¥å’Œå·¥ä½œè¿æ¥ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">checkProxy</span><span class="params">(req *msg.ClientCtlReq, c *conn.Conn)</span></span> (succ <span class="type">bool</span>, info <span class="type">string</span>, needRes <span class="type">bool</span>) &#123;</span><br><span class="line">	succ = <span class="literal">false</span>    <span class="comment">// é»˜è®¤è®¾ç½®æˆåŠŸæ ‡å¿—ä¸º false</span></span><br><span class="line">	needRes = <span class="literal">true</span>  <span class="comment">// é»˜è®¤éœ€è¦å‘å®¢æˆ·ç«¯å‘é€å“åº”</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// æ£€æŸ¥ä»£ç†åç§°æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">	s, ok := server.ProxyServers[req.ProxyName]</span><br><span class="line">	<span class="keyword">if</span> !ok &#123;</span><br><span class="line">		info = fmt.Sprintf(<span class="string">&quot;ProxyName [%s] is not exist&quot;</span>, req.ProxyName)</span><br><span class="line">		log.Warn(info)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// æ£€æŸ¥å¯†ç æ˜¯å¦æ­£ç¡®</span></span><br><span class="line">	<span class="keyword">if</span> req.Passwd != s.Passwd &#123;</span><br><span class="line">		info = fmt.Sprintf(<span class="string">&quot;ProxyName [%s], password is not correct&quot;</span>, req.ProxyName)</span><br><span class="line">		log.Warn(info)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// æ ¹æ®è¯·æ±‚ç±»å‹å¤„ç†æ§åˆ¶è¿æ¥æˆ–å·¥ä½œè¿æ¥</span></span><br><span class="line">	<span class="keyword">if</span> req.Type == consts.CtlConn &#123;</span><br><span class="line">		<span class="comment">// å¦‚æœæ˜¯æ§åˆ¶è¿æ¥</span></span><br><span class="line">		<span class="keyword">if</span> s.Status != consts.Idle &#123;</span><br><span class="line">            <span class="comment">// å¦‚æœä»£ç†å·²ç»åœ¨ä½¿ç”¨ä¸­ï¼Œè®¾ç½®é”™è¯¯ä¿¡æ¯</span></span><br><span class="line">			info = fmt.Sprintf(<span class="string">&quot;ProxyName [%s], already in use&quot;</span>, req.ProxyName)</span><br><span class="line">			log.Warn(info)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// å¯åŠ¨ä»£ç†å¹¶ç›‘å¬ç”¨æˆ·è¿æ¥ï¼Œæ­¤æ“ä½œä¸ä¼šé˜»å¡</span></span><br><span class="line">		err := s.Start()</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			info = fmt.Sprintf(<span class="string">&quot;ProxyName [%s], start proxy error: %v&quot;</span>, req.ProxyName, err.Error())</span><br><span class="line">			log.Warn(info)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		log.Info(<span class="string">&quot;ProxyName [%s], start proxy success&quot;</span>, req.ProxyName)</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> req.Type == consts.WorkConn &#123;</span><br><span class="line">		<span class="comment">// å¦‚æœæ˜¯å·¥ä½œè¿æ¥ï¼Œåˆ™ä¸éœ€è¦å‘å®¢æˆ·ç«¯å‘é€å“åº”</span></span><br><span class="line">		needRes = <span class="literal">false</span></span><br><span class="line">		<span class="keyword">if</span> s.Status != consts.Working &#123;</span><br><span class="line">			log.Warn(<span class="string">&quot;ProxyName [%s], is not working when it gets one new work conn&quot;</span>, req.ProxyName)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		s.GetNewCliConn(c) <span class="comment">// è·å–æ–°çš„å®¢æˆ·ç«¯è¿æ¥</span></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		info = fmt.Sprintf(<span class="string">&quot;ProxyName [%s], type [%d] unsupport&quot;</span>, req.ProxyName, req.Type)</span><br><span class="line">		log.Warn(info)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœæ‰€æœ‰æ£€æŸ¥éƒ½é€šè¿‡ï¼Œåˆ™è®¾ç½®æˆåŠŸæ ‡å¿—ä¸º true</span></span><br><span class="line">	succ = <span class="literal">true</span></span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­æ§åˆ¶è¿æ¥ä¸»è¦ç”¨äºè®¾ç½®å’Œç»´æŠ¤å·¥ä½œè¿æ¥ï¼Œä»¥åŠè¿›è¡Œå¿ƒè·³æ£€æµ‹æ¥ç¡®ä¿å®¢æˆ·ç«¯ä»ç„¶æ´»è·ƒã€‚</p>
<p>æ§åˆ¶è¿æ¥æ˜¯å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ä¹‹é—´çš„åˆå§‹è¿æ¥ï¼Œç”¨äºç®¡ç†å’Œæ§åˆ¶ä»£ç†çš„çŠ¶æ€ã€‚åœ¨æ§åˆ¶è¿æ¥ä¸­ï¼Œå®¢æˆ·ç«¯ä¼šå‘é€ä¸€ä¸ªåŒ…å«ä»£ç†åç§°å’Œå¯†ç çš„è¯·æ±‚ï¼ŒæœåŠ¡å™¨ä¼šéªŒè¯è¿™äº›ä¿¡æ¯ï¼Œå¦‚æœéªŒè¯æˆåŠŸï¼ŒæœåŠ¡å™¨å°±ä¼šæ ¹æ®è¯·æ±‚çš„ç±»å‹æ¥å¯åŠ¨ä»£ç†æˆ–å¤„ç†å…¶ä»–æ§åˆ¶æ¶ˆæ¯ã€‚</p>
<p>è€Œå·¥ä½œè¿æ¥æ˜¯åœ¨æ§åˆ¶è¿æ¥å»ºç«‹åç”±å®¢æˆ·ç«¯å‘èµ·çš„ï¼Œç”¨äºå®é™…çš„æ•°æ®ä¼ è¾“ã€‚å·¥ä½œè¿æ¥å…è®¸ç”¨æˆ·æ•°æ®é€šè¿‡ä»£ç†æœåŠ¡å™¨è½¬å‘ï¼Œå®ç°å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ä¹‹é—´çš„é€šä¿¡ã€‚</p>
<p><code>readControlMsgFromClient</code> å‡½æ•°ç”¨äºè¯»å–å®¢æˆ·ç«¯å‘é€çš„æ§åˆ¶ä¿¡æ¯ ï¼Œå®ƒæ¥å—ä¸€ä¸ªä»£ç†æœåŠ¡å™¨å’Œè¿æ¥ä½œä¸ºå‚æ•°ï¼Œç”¨äºè¯»å–å®¢æˆ·ç«¯å‘é€çš„æ§åˆ¶æ¶ˆæ¯ï¼ŒåŒ…æ‹¬å¯¹å¿ƒè·³ä¿¡æ¯çš„å¤„ç†ï¼Œç”¨äºä¿æŒå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„è¿æ¥ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">readControlMsgFromClient</span><span class="params">(s *server.ProxyServer, c *conn.Conn)</span></span> &#123;</span><br><span class="line">	<span class="comment">// ç”¨äºæ§åˆ¶å¾ªç¯è¯»å–æ¶ˆæ¯çš„æ¡ä»¶</span></span><br><span class="line">	isContinueRead := <span class="literal">true</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">// ç”¨äºå¤„ç†å¿ƒè·³è¶…æ—¶çš„æƒ…å†µï¼Œè¶…æ—¶åˆ™å…³é—­æœåŠ¡å™¨è¿æ¥</span></span><br><span class="line">	f := <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		isContinueRead = <span class="literal">false</span></span><br><span class="line">		s.Close()</span><br><span class="line">		log.Error(<span class="string">&quot;ProxyName [%s], client heartbeat timeout&quot;</span>, s.Name)</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// åˆ›å»ºä¸€ä¸ªå®šæ—¶å™¨ timerï¼Œåœ¨ HeartBeatTimeout æ—¶é—´åæ‰§è¡Œå‡½æ•° f</span></span><br><span class="line">	timer := time.AfterFunc(time.Duration(server.HeartBeatTimeout)*time.Second, f)</span><br><span class="line">	<span class="comment">// defer è¯­å¥ä¿è¯åœ¨å‡½æ•°ç»“æŸæ—¶åœæ­¢å®šæ—¶å™¨ã€‚</span></span><br><span class="line">	<span class="keyword">defer</span> timer.Stop()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// å¾ªç¯è¯»å–å®¢æˆ·ç«¯å‘é€çš„æ¶ˆæ¯ï¼Œè¿æ¥è¶…æ—¶åˆ™è·³å‡ºå¾ªç¯</span></span><br><span class="line">	<span class="keyword">for</span> isContinueRead &#123;</span><br><span class="line">		<span class="comment">// ä»è¿æ¥ c ä¸­è¯»å–ä¸€è¡Œæ¶ˆæ¯ï¼Œå­˜å‚¨åœ¨ content ä¸­</span></span><br><span class="line">		content, err := c.ReadLine()</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> err == io.EOF &#123;</span><br><span class="line">				log.Warn(<span class="string">&quot;ProxyName [%s], client is dead!&quot;</span>, s.Name)</span><br><span class="line">				s.Close()</span><br><span class="line">				<span class="keyword">break</span></span><br><span class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> <span class="literal">nil</span> == c || c.IsClosed() &#123;</span><br><span class="line">				log.Warn(<span class="string">&quot;ProxyName [%s], client connection is closed&quot;</span>, s.Name)</span><br><span class="line">				<span class="keyword">break</span></span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			log.Error(<span class="string">&quot;ProxyName [%s], read error: %v&quot;</span>, s.Name, err)</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// åˆ›å»ºä¸€ä¸ªæŒ‡é’ˆï¼Œå­˜å‚¨è§£æåçš„å®¢æˆ·ç«¯æ§åˆ¶è¯·æ±‚æ¶ˆæ¯</span></span><br><span class="line">		clientCtlReq := &amp;msg.ClientCtlReq&#123;&#125;</span><br><span class="line">		<span class="comment">// å°† content è§£æä¸º msg.ClientCtlReq ç»“æ„ä½“ï¼Œå¹¶å°†è§£æç»“æœå­˜å‚¨åœ¨ clientCtlReq ä¸­</span></span><br><span class="line">		<span class="keyword">if</span> err := json.Unmarshal([]<span class="type">byte</span>(content), clientCtlReq); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Warn(<span class="string">&quot;Parse err: %v : %s&quot;</span>, err, content)</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// åˆ¤æ–­æ¶ˆæ¯æ˜¯å¦ä¸ºå¿ƒè·³è¯·æ±‚</span></span><br><span class="line">		<span class="keyword">if</span> consts.CSHeartBeatReq == clientCtlReq.Type &#123;</span><br><span class="line">			log.Debug(<span class="string">&quot;ProxyName [%s], get heartbeat&quot;</span>, s.Name)</span><br><span class="line">			<span class="comment">// é‡ç½®å®šæ—¶å™¨ï¼Œå»¶é•¿å¿ƒè·³è¶…æ—¶æ—¶é—´ï¼Œç¡®ä¿å®¢æˆ·ç«¯ä¿æŒæ´»è·ƒ</span></span><br><span class="line">			timer.Reset(time.Duration(server.HeartBeatTimeout) * time.Second)</span><br><span class="line">			clientCtlRes := &amp;msg.ClientCtlRes&#123;&#125;</span><br><span class="line">			<span class="comment">// è®¾ç½®å¿ƒè·³å“åº”æ¶ˆæ¯çš„å“åº”ç ä¸º consts.SCHeartBeatResï¼Œç„¶åå°†å“åº”åºåˆ—åŒ–ä¸º JSON æ ¼å¼å­—ç¬¦ä¸²</span></span><br><span class="line">			clientCtlRes.GeneralRes.Code = consts.SCHeartBeatRes</span><br><span class="line">			response, err := json.Marshal(clientCtlRes)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				log.Warn(<span class="string">&quot;Serialize ClientCtlRes err! err: %v&quot;</span>, err)</span><br><span class="line">				<span class="keyword">continue</span></span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			err = c.Write(<span class="type">string</span>(response) + <span class="string">&quot;\\n&quot;</span>)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				log.Error(<span class="string">&quot;Send heartbeat response to client failed! Err:%v&quot;</span>, err)</span><br><span class="line">				<span class="keyword">continue</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="frpc"><a href="#frpc" class="headerlink" title="frpc"></a>frpc</h3><p><code>ini</code> é…ç½®æ–‡ä»¶å¦‚ä¸‹ï¼š</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[common]</span></span><br><span class="line"><span class="attr">server_addr</span> = <span class="number">127.0</span>.<span class="number">0.1</span></span><br><span class="line"><span class="attr">server_port</span> = <span class="number">7000</span></span><br><span class="line"><span class="attr">log_file</span> = ./frpc.log</span><br><span class="line"><span class="comment"># debug, info, warn, error</span></span><br><span class="line"><span class="attr">log_level</span> = debug</span><br><span class="line"><span class="comment"># file, console</span></span><br><span class="line"><span class="attr">log_way</span> = console</span><br><span class="line"></span><br><span class="line"><span class="section">[test1]</span></span><br><span class="line"><span class="attr">passwd</span> = <span class="number">123</span></span><br><span class="line"><span class="attr">local_port</span> = <span class="number">22</span></span><br></pre></td></tr></table></figure>

<p>åŒæ ·æ˜¯å…¥å£æ–‡ä»¶å¼€å§‹ï¼Œä½ç½®æ˜¯ <code>src/frp/cmd/frpc/main.go</code>ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	err := client.LoadConf(<span class="string">&quot;./frpc.ini&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		os.Exit(<span class="number">-1</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	log.InitLog(client.LogWay, client.LogFile, client.LogLevel)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ç­‰å¾…æ‰€æœ‰æ§åˆ¶åç¨‹é€€å‡ºï¼Œå®é™…ä¸Šæ˜¯åœ¨å£°æ˜å°†ä¼šæœ‰ len(client.ProxyClients) æ•°é‡çš„åç¨‹</span></span><br><span class="line">	<span class="keyword">var</span> wait sync.WaitGroup</span><br><span class="line">	wait.Add(<span class="built_in">len</span>(client.ProxyClients))</span><br><span class="line"></span><br><span class="line">    <span class="comment">// éå†æ‰€æœ‰ä»£ç†å®¢æˆ·ç«¯ï¼Œå¹¶ä¸ºæ¯ä¸ªå®¢æˆ·ç«¯å¯åŠ¨ä¸€ä¸ªæ§åˆ¶åç¨‹</span></span><br><span class="line">	<span class="keyword">for</span> _, client := <span class="keyword">range</span> client.ProxyClients &#123;</span><br><span class="line">		<span class="keyword">go</span> ControlProcess(client, &amp;wait)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	log.Info(<span class="string">&quot;Start frpc success&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç­‰å¾…æ‰€æœ‰æ§åˆ¶åç¨‹é€€å‡º</span></span><br><span class="line">	wait.Wait()</span><br><span class="line">	log.Warn(<span class="string">&quot;All proxy exit!&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åŠ è½½é…ç½®æ–‡ä»¶å’Œæ—¥å¿—åˆå§‹åŒ–éƒ½è®²è¿‡äº†ï¼Œä¸å†èµ˜è¿°ã€‚å°†ç›®å…‰ç§»è‡³ <code>src/frp/cmd/frpc/control.go</code>ï¼Œçœ‹çœ‹ç”¨äºå¤„ç†å®¢æˆ·ç«¯çš„ <code>ControlProcess()</code>ã€‚å…¶ä¸­å…³é”®å‡½æ•°æ˜¯ç”¨äºè¿æ¥æœåŠ¡ç«¯çš„ <code>loginToServer</code> å‡½æ•°ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ControlProcess</span><span class="params">(cli *client.ProxyClient, wait *sync.WaitGroup)</span></span> &#123;</span><br><span class="line">    <span class="comment">// å»¶è¿Ÿ wait.Done() çš„æ‰§è¡Œç›´åˆ° ControlProcess( )å‡½æ•°å³å°†è¿”å›</span></span><br><span class="line">    <span class="comment">// è¿™æ˜¯é€šçŸ¥ sync.WaitGroup å½“å‰åç¨‹å·²ç»å®Œæˆçš„æ ‡å‡†æ–¹å¼</span></span><br><span class="line">	<span class="keyword">defer</span> wait.Done()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// â˜… å°è¯•ç™»å½•åˆ°æœåŠ¡å™¨ï¼Œå¦‚æœæˆåŠŸï¼Œè¿”å›ä¸€ä¸ªè¿æ¥å¯¹è±¡</span></span><br><span class="line">	c, err := loginToServer(cli)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Error(<span class="string">&quot;ProxyName [%s], connect to server failed!&quot;</span>, cli.Name)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	connection = c</span><br><span class="line">    <span class="comment">// ç¡®ä¿å‡½æ•°ç»“æŸæ—¶å…³é—­ç½‘ç»œè¿æ¥</span></span><br><span class="line">	<span class="keyword">defer</span> connection.Close()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ— é™å¾ªç¯å¹¶ä»æœåŠ¡å™¨è¯»å–æ•°æ®</span></span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		content, err := connection.ReadLine()</span><br><span class="line">        <span class="comment">// é‡åˆ° io.EOF æˆ–è¿æ¥è¢«å…³é—­ï¼Œå°è¯•é‡æ–°è¿æ¥æœåŠ¡å™¨</span></span><br><span class="line">		<span class="keyword">if</span> err == io.EOF || <span class="literal">nil</span> == connection || connection.IsClosed() &#123;</span><br><span class="line">			log.Debug(<span class="string">&quot;ProxyName [%s], server close this control conn&quot;</span>, cli.Name)</span><br><span class="line">			</span><br><span class="line">            <span class="comment">// ä½¿ç”¨æŒ‡æ•°é€€é¿ç­–ç•¥æ¥é‡è¿æœåŠ¡å™¨ï¼Œæ¯æ¬¡å¤±è´¥åç­‰å¾…æ—¶é—´ç¿»å€ï¼Œç›´åˆ°æœ€å¤§ 60 ç§’</span></span><br><span class="line">            <span class="keyword">var</span> sleepTime time.Duration = <span class="number">1</span></span><br><span class="line">			<span class="keyword">for</span> &#123;</span><br><span class="line">				log.Debug(<span class="string">&quot;ProxyName [%s], try to reconnect to server[%s:%d]...&quot;</span>, cli.Name, client.ServerAddr, client.ServerPort)</span><br><span class="line">				tmpConn, err := loginToServer(cli)</span><br><span class="line">				<span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line">					connection.Close()</span><br><span class="line">					connection = tmpConn</span><br><span class="line">					<span class="keyword">break</span></span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				<span class="keyword">if</span> sleepTime &lt; <span class="number">60</span> &#123;</span><br><span class="line">					sleepTime = sleepTime * <span class="number">2</span></span><br><span class="line">				&#125;</span><br><span class="line">				time.Sleep(sleepTime * time.Second)</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Warn(<span class="string">&quot;ProxyName [%s], read from server error, %v&quot;</span>, cli.Name, err)</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å°è¯•è§£ææœåŠ¡å™¨è¿”å›çš„å†…å®¹ä¸º ClientCtlRes ç»“æ„ä½“</span></span><br><span class="line">		clientCtlRes := &amp;msg.ClientCtlRes&#123;&#125;</span><br><span class="line">		<span class="keyword">if</span> err := json.Unmarshal([]<span class="type">byte</span>(content), clientCtlRes); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Warn(<span class="string">&quot;Parse err: %v : %s&quot;</span>, err, content)</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ£€æŸ¥æ˜¯å¦æ”¶åˆ°å¿ƒè·³å“åº”ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™é‡ç½®å¿ƒè·³è®¡æ—¶å™¨</span></span><br><span class="line">		<span class="keyword">if</span> consts.SCHeartBeatRes == clientCtlRes.GeneralRes.Code &#123;</span><br><span class="line">			<span class="keyword">if</span> heartBeatTimer != <span class="literal">nil</span> &#123;</span><br><span class="line">				log.Debug(<span class="string">&quot;Client rcv heartbeat response&quot;</span>)</span><br><span class="line">				heartBeatTimer.Reset(time.Duration(client.HeartBeatTimeout) * time.Second)</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				log.Error(<span class="string">&quot;heartBeatTimer is nil&quot;</span>)</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// â˜… å¦‚æœæ”¶åˆ°çš„ä¸æ˜¯å¿ƒè·³å“åº”ï¼Œåˆ™å°è¯•å¯åŠ¨éš§é“</span></span><br><span class="line">		cli.StartTunnel(client.ServerAddr, client.ServerPort)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥æ˜¯ <code>loginToServer</code> å‡½æ•°ï¼Œæ ¸å¿ƒå‡½æ•°æœ‰ä¸¤ä¸ªï¼Œåˆ†åˆ«æ˜¯ç”¨äºè¿æ¥åˆ°æŒ‡å®šåœ°å€ç«¯å£çš„ <code>ConnectServer</code> å’Œç”¨äºå¯åŠ¨å¿ƒè·³æ£€æµ‹çš„ <code>startHeartBeat</code> å‡½æ•°ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">loginToServer</span><span class="params">(cli *client.ProxyClient)</span></span> (c *conn.Conn, err <span class="type">error</span>) &#123;</span><br><span class="line">	<span class="comment">// â˜… å»ºç«‹è¿æ¥ï¼Œè¿”å›ä¸€ä¸ªè¿æ¥å¯¹è±¡</span></span><br><span class="line">    c, err = conn.ConnectServer(client.ServerAddr, client.ServerPort)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Error(<span class="string">&quot;ProxyName [%s], connect to server [%s:%d] error, %v&quot;</span>, cli.Name, client.ServerAddr, client.ServerPort, err)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// åˆ›å»ºä¸€ä¸ª ClientCtlReq ç»“æ„ä½“ï¼ŒæŒ‡å®šè¯·æ±‚ç±»å‹ CtlConnï¼Œè¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªæ§åˆ¶è¿æ¥è¯·æ±‚</span></span><br><span class="line">	req := &amp;msg.ClientCtlReq&#123;</span><br><span class="line">		Type:      consts.CtlConn,</span><br><span class="line">		ProxyName: cli.Name,</span><br><span class="line">		Passwd:    cli.Passwd,</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">// åºåˆ—åŒ–ä¸º JSON å¹¶å‘é€è¯·æ±‚</span></span><br><span class="line">	buf, _ := json.Marshal(req)</span><br><span class="line">	err = c.Write(<span class="type">string</span>(buf) + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Error(<span class="string">&quot;ProxyName [%s], write to server error, %v&quot;</span>, cli.Name, err)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¯»å–å“åº”</span></span><br><span class="line">	res, err := c.ReadLine()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Error(<span class="string">&quot;ProxyName [%s], read from server error, %v&quot;</span>, cli.Name, err)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	log.Debug(<span class="string">&quot;ProxyName [%s], read [%s]&quot;</span>, cli.Name, res)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°†å“åº”çš„å†…å®¹è§£æä¸º ClientCtlRes ç»“æ„ä½“</span></span><br><span class="line">	clientCtlRes := &amp;msg.ClientCtlRes&#123;&#125;</span><br><span class="line">	<span class="keyword">if</span> err = json.Unmarshal([]<span class="type">byte</span>(res), &amp;clientCtlRes); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Error(<span class="string">&quot;ProxyName [%s], format server response error, %v&quot;</span>, cli.Name, err)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ£€æŸ¥å“åº”ä»£ç </span></span><br><span class="line">	<span class="keyword">if</span> clientCtlRes.Code != <span class="number">0</span> &#123;</span><br><span class="line">		log.Error(<span class="string">&quot;ProxyName [%s], start proxy error, %s&quot;</span>, cli.Name, clientCtlRes.Msg)</span><br><span class="line">		<span class="keyword">return</span> c, fmt.Errorf(<span class="string">&quot;%s&quot;</span>, clientCtlRes.Msg)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// â˜… å¯åŠ¨å¿ƒè·³</span></span><br><span class="line">	<span class="keyword">go</span> startHeartBeat(c)</span><br><span class="line">	log.Debug(<span class="string">&quot;ProxyName [%s], connect to server[%s:%d] success!&quot;</span>, cli.Name, client.ServerAddr, client.ServerPort)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…ˆçœ‹å®ç°è¿æ¥çš„<code>ConnectServer</code> å‡½æ•°ï¼Œä½äº <code>utils/conn</code>ã€‚è¿™ä¸ªå‡½æ•°å®é™…ä¸Šæ˜¯å¯¹æ™®é€š TCP è¿æ¥çš„å°è£…ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Conn <span class="keyword">struct</span> &#123;</span><br><span class="line">	TcpConn   *net.TCPConn</span><br><span class="line">	Reader    *bufio.Reader</span><br><span class="line">	closeFlag <span class="type">bool</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ConnectServer</span><span class="params">(host <span class="type">string</span>, port <span class="type">int64</span>)</span></span> (c *Conn, err <span class="type">error</span>) &#123;</span><br><span class="line">	c = &amp;Conn&#123;&#125;</span><br><span class="line">    <span class="comment">// ä½¿ç”¨ net.ResolveTCPAddr è§£æ TCP åœ°å€</span></span><br><span class="line">	servertAddr, err := net.ResolveTCPAddr(<span class="string">&quot;tcp4&quot;</span>, fmt.Sprintf(<span class="string">&quot;%s:%d&quot;</span>, host, port))</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">// å»ºç«‹åˆ°æœåŠ¡å™¨çš„ TCP è¿æ¥</span></span><br><span class="line">	conn, err := net.DialTCP(<span class="string">&quot;tcp&quot;</span>, <span class="literal">nil</span>, servertAddr)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">// å°†å»ºç«‹çš„ TCP è¿æ¥èµ‹ç»™ Conn ç»“æ„ä½“çš„ TcpConn å­—æ®µ</span></span><br><span class="line">	c.TcpConn = conn</span><br><span class="line">    <span class="comment">// åˆ›å»ºä¸€ä¸ªæ–°çš„ç¼“å†²è¯»å–å™¨ï¼Œå¹¶èµ‹ç»™ Conn çš„ Reader å­—æ®µ</span></span><br><span class="line">	c.Reader = bufio.NewReader(c.TcpConn)</span><br><span class="line">    <span class="comment">// è¡¨ç¤ºè¿æ¥ç›®å‰æ˜¯æ‰“å¼€çš„</span></span><br><span class="line">	c.closeFlag = <span class="literal">false</span></span><br><span class="line">	<span class="keyword">return</span> c, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åŒæ–‡ä»¶ä¸­ç”¨äºæ“ä½œ Conn ç»“æ„ä½“çš„å‡½æ•°æ­¤å¤„ä¸å†å±•ç¤º</span></span><br><span class="line"><span class="comment">// è¿˜æœ‰ä¸€ä¸ªç”¨äºå®ç°éš§é“é€šä¿¡çš„ Join å‡½æ•°ï¼Œç¨åä¼šè¯´</span></span><br></pre></td></tr></table></figure>

<p>ç„¶åçœ‹ <code>startHeartBeat</code> å‡½æ•°ï¼Œè¯¥å‡½æ•°ç”¨äºå‘èµ·å¿ƒè·³åŒ…ç»´æŒå®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯çš„è¿æ¥ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">startHeartBeat</span><span class="params">(c *conn.Conn)</span></span> &#123;</span><br><span class="line">    <span class="comment">// å¿ƒè·³è¶…æ—¶åˆ™å…³é—­è¿æ¥</span></span><br><span class="line">	f := <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		log.Error(<span class="string">&quot;HeartBeat timeout!&quot;</span>)</span><br><span class="line">		<span class="keyword">if</span> c != <span class="literal">nil</span> &#123;</span><br><span class="line">			c.Close()</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">   	<span class="comment">// åˆ›å»ºä¸€ä¸ªè®¡æ—¶å™¨ï¼Œåœ¨æŒ‡å®šçš„å¿ƒè·³è¶…æ—¶æ—¶é—´åæ‰§è¡Œå‡½æ•°f</span></span><br><span class="line">	heartBeatTimer = time.AfterFunc(time.Duration(client.HeartBeatTimeout)*time.Second, f)</span><br><span class="line">	<span class="comment">// ç¡®ä¿åœ¨å‡½æ•°é€€å‡ºå‰åœæ­¢è®¡æ—¶å™¨</span></span><br><span class="line">    <span class="keyword">defer</span> heartBeatTimer.Stop()</span><br><span class="line"></span><br><span class="line">	clientCtlReq := &amp;msg.ClientCtlReq&#123;</span><br><span class="line">		Type:      consts.CSHeartBeatReq,</span><br><span class="line">		ProxyName: <span class="string">&quot;&quot;</span>,</span><br><span class="line">		Passwd:    <span class="string">&quot;&quot;</span>,</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å°†å¿ƒè·³è¯·æ±‚åºåˆ—åŒ–ä¸ºJSONæ ¼å¼</span></span><br><span class="line">	request, err := json.Marshal(clientCtlReq)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Warn(<span class="string">&quot;Serialize clientCtlReq err! Err: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿›å…¥ä¸€ä¸ªæ— é™å¾ªç¯ï¼Œæ¯æ¬¡å¾ªç¯å¼€å§‹æ—¶éƒ½ä¼šä¼‘çœ ä¸€æ®µæ—¶é—´ï¼Œè¿™ä¸ªæ—¶é—´ç”±å¿ƒè·³é—´éš”å†³å®š</span></span><br><span class="line">	log.Debug(<span class="string">&quot;Start to send heartbeat&quot;</span>)</span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		time.Sleep(time.Duration(client.HeartBeatInterval) * time.Second)</span><br><span class="line">		<span class="keyword">if</span> c != <span class="literal">nil</span> &amp;&amp; !c.IsClosed() &#123;</span><br><span class="line">			err = c.Write(<span class="type">string</span>(request) + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				log.Error(<span class="string">&quot;Send hearbeat to server failed! Err:%v&quot;</span>, err)</span><br><span class="line">				<span class="keyword">continue</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	log.Debug(<span class="string">&quot;Heartbeat exit&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç°åœ¨ï¼Œæˆ‘ä»¬å®ç°äº†å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯çš„è¿æ¥ï¼Œå¹¶åœ¨è¿æ¥åä¾é å¿ƒè·³æœºåˆ¶å®ç°äº†ç»´æŒé€šä¿¡ï¼Œä¸‹ä¸€æ­¥å°±æ˜¯å»ºç«‹éš§é“ï¼Œå®ç°é€šä¿¡åŠŸèƒ½ã€‚è§†è§’è½¬åˆ° <code>utils/conn</code> çš„ <code>StartTunnel</code> å‡½æ•°ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *ProxyClient)</span></span> StartTunnel(serverAddr <span class="type">string</span>, serverPort <span class="type">int64</span>) (err <span class="type">error</span>) &#123;</span><br><span class="line">	<span class="comment">// å»ºç«‹åˆ°æœ¬åœ°æœåŠ¡çš„è¿æ¥</span></span><br><span class="line">    localConn, err := p.GetLocalConn()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// â˜… å»ºç«‹åˆ°æœåŠ¡ç«¯çš„è¿æ¥</span></span><br><span class="line">    remoteConn, err := p.GetRemoteConn(serverAddr, serverPort)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// l means local, r means remote</span></span><br><span class="line">	log.Debug(<span class="string">&quot;Join two conns, (l[%s] r[%s]) (l[%s] r[%s])&quot;</span>, localConn.GetLocalAddr(), localConn.GetRemoteAddr(),</span><br><span class="line">		remoteConn.GetLocalAddr(), remoteConn.GetRemoteAddr())</span><br><span class="line">    <span class="comment">// â˜… åˆ›å»ºåç¨‹å°†æœ¬åœ°è¿æ¥å’Œè¿œç¨‹è¿æ¥â€œè¿æ¥â€èµ·æ¥ï¼Œä½¿å¾—æ•°æ®å¯ä»¥åœ¨ä¸¤è€…ä¹‹é—´ä¼ è¾“</span></span><br><span class="line">	<span class="keyword">go</span> conn.Join(localConn, remoteConn)</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å»ºç«‹åˆ°æœ¬åœ°æœåŠ¡çš„è¿æ¥æ²¡ä»€ä¹ˆå¥½è¯´çš„ï¼Œè·å–é…ç½®æ–‡ä»¶ä¸­çš„æœ¬åœ°ç«¯å£åšä¸ªè°ƒç”¨å³å¯ã€‚ç€é‡çœ‹ä¸‹ <code>GetRemoteConn</code> å‡½æ•°ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *ProxyClient)</span></span> GetRemoteConn(addr <span class="type">string</span>, port <span class="type">int64</span>) (c *conn.Conn, err <span class="type">error</span>) &#123;</span><br><span class="line">    <span class="comment">// ä½¿ç”¨ defer å…³é”®å­—æ¥ç¡®ä¿åœ¨å‡½æ•°è¿”å›å‰å…³é—­è¿æ¥</span></span><br><span class="line">	<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			c.Close()</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	c, err = conn.ConnectServer(addr, port)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Error(<span class="string">&quot;ProxyName [%s], connect to server [%s:%d] error, %v&quot;</span>, p.Name, addr, port, err)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ„é€ ä¸€ä¸ªå®¢æˆ·ç«¯æ§åˆ¶è¯·æ±‚æ¶ˆæ¯ï¼Œå£°æ˜ä¸ºå·¥ä½œè¿æ¥</span></span><br><span class="line">	req := &amp;msg.ClientCtlReq&#123;</span><br><span class="line">		Type:      consts.WorkConn,</span><br><span class="line">		ProxyName: p.Name,</span><br><span class="line">		Passwd:    p.Passwd,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°†è¯·æ±‚åºåˆ—åŒ–ä¸º JSON æ ¼å¼å¹¶å‘é€</span></span><br><span class="line">	buf, _ := json.Marshal(req)</span><br><span class="line">	err = c.Write(<span class="type">string</span>(buf) + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Error(<span class="string">&quot;ProxyName [%s], write to server error, %v&quot;</span>, p.Name, err)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	err = <span class="literal">nil</span></span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æœ€åæˆ‘ä»¬å†è½¬åˆ° <code>Join</code> å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°æ˜¯æ­å»ºéš§é“çš„å…³é”®ï¼Œæœ¬è´¨ä¸Šå°±æ˜¯å®ç°ä¸¤ä¸ªè¿æ¥ä¹‹é—´çš„åŒå‘æ•°æ®ä¼ è¾“ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Join</span><span class="params">(c1 *Conn, c2 *Conn)</span></span> &#123;</span><br><span class="line">    <span class="comment">// ç­‰å¾…ä¸¤ä¸ªæ•°æ®ä¼ è¾“åç¨‹çš„å®Œæˆ</span></span><br><span class="line">	<span class="keyword">var</span> wait sync.WaitGroup</span><br><span class="line">    <span class="comment">// ä»ä¸€ä¸ªè¿æ¥è¯»å–æ•°æ®å¹¶å†™å…¥åˆ°å¦ä¸€ä¸ªè¿æ¥</span></span><br><span class="line">    <span class="comment">// defer ç”¨äºç¡®ä¿åœ¨å‡½æ•°ç»“æŸæ—¶å…³é—­è¿æ¥å¹¶é€šçŸ¥ WaitGroup åç¨‹å·²å®Œæˆ</span></span><br><span class="line">	pipe := <span class="function"><span class="keyword">func</span><span class="params">(to *Conn, from *Conn)</span></span> &#123;</span><br><span class="line">		<span class="keyword">defer</span> to.Close()</span><br><span class="line">		<span class="keyword">defer</span> from.Close()</span><br><span class="line">		<span class="keyword">defer</span> wait.Done()</span><br><span class="line"></span><br><span class="line">		<span class="keyword">var</span> err <span class="type">error</span></span><br><span class="line">        <span class="comment">// ä½¿ç”¨ io.Copy å‡½æ•°å°†æ•°æ®ä»ä¸€ä¸ªè¿æ¥å¤åˆ¶åˆ°å¦ä¸€ä¸ªè¿æ¥</span></span><br><span class="line">        <span class="comment">// è¿™ä¸ªæ“ä½œä¼šæŒç»­è¿›è¡Œï¼Œç›´åˆ°é‡åˆ°é”™è¯¯æˆ–è€…EOFï¼ˆæ–‡ä»¶ç»“æŸæ ‡å¿—</span></span><br><span class="line">		_, err = io.Copy(to.TcpConn, from.TcpConn)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Warn(<span class="string">&quot;join conns error, %v&quot;</span>, err)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	wait.Add(<span class="number">2</span>)</span><br><span class="line">    <span class="comment">// å¯åŠ¨ä¸¤ä¸ªåç¨‹ï¼Œåˆ†åˆ«å¤„ç†ä» c1 åˆ° c2 å’Œä» c2 åˆ° c1 çš„æ•°æ®ä¼ è¾“</span></span><br><span class="line">	<span class="keyword">go</span> pipe(c1, c2)</span><br><span class="line">	<span class="keyword">go</span> pipe(c2, c1)</span><br><span class="line">	wait.Wait()</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="åè¯"><a href="#åè¯" class="headerlink" title="åè¯"></a>åè¯</h2><p>Okï¼Œè‡³æ­¤ï¼Œfrp v0.1.0 çš„æºç å°±åˆ†æçš„å·®ä¸å¤šäº†ï¼Œè™½è¯´æœ‰ç‚¹è€ï¼ˆæ¥è¿‘ 10 å¹´å‰ï¼‰ï¼Œä½†å¯¹ç†è§£å†…ç½‘ç©¿é€çš„å®ç°åŸç†ä¹Ÿæ˜¯å¾ˆæœ‰å¸®åŠ©çš„ã€‚ä¹‹åçš„ç‰ˆæœ¬ä¸­è™½ç„¶åšäº†å¾ˆå¤šæ”¹è¿›ï¼Œä½†æ•´ä½“å®ç°æ€è·¯å…¶å®æ²¡æœ‰å¤ªå¤§å˜åŒ–ã€‚</p>
<p>è™½è¯´ä¸æ˜¯ç¬¬ä¸€æ¬¡è¯•ç€å»é˜…è¯»æŸä¸ªå·¥å…·çš„æºç ï¼Œä½†è¾¹å­¦è¾¹å†™åšæ–‡è¿˜æ˜¯ç¬¬ä¸€æ¬¡ï¼Œå¯èƒ½ç•¥æœ‰æ··ä¹±ï¼Œä½†æ„Ÿè§‰ä¹Ÿè¿˜å¥½ï¼Ÿå”¯ä¸€çš„é—®é¢˜æ˜¯ä¸é€‚åˆæŠŠä¸€æ®µä»£ç æ‹†å¼€ï¼Œä»¥ frpc çš„ <code>controlWorker</code> ä¸¾ä¾‹ï¼Œé‡Œé¢å…ˆåä½¿ç”¨äº†ä¸¤ä¸ªé‡è¦å‡½æ•°ï¼Œä¸€èˆ¬è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä¼šæŒ‰ç…§ä»£ç æ‰§è¡Œé€»è¾‘å…ˆè·³è½¬åˆ°å¯¹åº”å‡½æ•°çœ‹çœ‹è¿™ä¸ªå‡½æ•°åšäº†ä»€ä¹ˆï¼Œçœ‹å®Œä¹‹åå†ã€‚ä½†å†™æ–‡ç« çš„æ—¶å€™æ‹†å¼€æ•´ä¸ªå‡½æ•°ï¼Œå…ˆè´´å‰åŠéƒ¨åˆ†ï¼Œä¸­é—´å†å¡è°ƒç”¨çš„å‡½æ•°ï¼Œç„¶åå†è´´ååŠæ®µå‡½æ•°ï¼Œå°±æ„Ÿè§‰å¾ˆæ€ªï¼Œæ‰€ä»¥åœ¨è¿™ç¯‡æ–‡ç« é‡Œï¼Œæˆ‘å°±ç›´æ¥å…ˆä»‹ç»æ•´ä¸ªå‡½æ•°ï¼Œæ ‡æ³¨å…¶ä¸­è°ƒç”¨çš„é‡è¦å‡½æ•°ï¼Œç„¶ååœ¨ä¹‹åå•ç‹¬ä»‹ç»ã€‚</p>
<p>ç„¶åé€šç¯‡å†™ä¸‹æ¥ï¼Œæƒ³è¦åæ§½çš„æ˜¯ Golang çš„é”™è¯¯å¤„ç†æœºåˆ¶ï¼Œä¸è®ºæ˜¯é˜…è¯»çš„æ—¶å€™è¿˜æ˜¯å†™æ–‡ç« çš„æ—¶å€™éƒ½æ„Ÿåˆ°ç•¥æœ‰éº»çƒ¦ã€‚å°±æ˜¯é‚£ç§ï¼Œå¤§å®¶éƒ½çŸ¥é“æŒ‰ç…§ Golang çš„é£æ ¼ä¼šåœ¨æ“ä½œè·Ÿä¸€ä¸ªé”™è¯¯å¤„ç†ï¼Œæ§åˆ¶æ—¥å¿—æ¨¡å—è¾“å‡ºäº›ä¿¡æ¯ï¼Œå¤šæ•°æƒ…å†µä¸‹å¯¹æ ¸å¿ƒåŠŸèƒ½çš„å®ç°æ²¡ä»€ä¹ˆå¸®åŠ©ï¼Œä½†ä½ åˆä¸å¥½çœç•¥ï¼Œå› ä¸ºå°±å¤šå‡ºä¸¤ä¸‰è¡Œï¼Œè´´ä»£ç çš„æ—¶å€™ç”¨ <code>// ... ...</code> ä»£æ›¿æ•ˆæœä¹Ÿæœ‰é™ï¼Œä½†ç›´æ¥çœå»ä¸å†™ä¹Ÿæ„Ÿè§‰å¾ˆä¸å¯¹ã€‚å°±æ¯”è¾ƒéš¾å—ã€‚</p>
<p>åˆ«çš„éƒ½è¿˜å¥½ã€‚</p>
<p>æˆ‘èƒ½æ‰¾åˆ°çš„è¿˜æœ‰ä¸€ç¯‡ FRP v0.5.0 æºç é˜…è¯»çš„æ–‡ç« ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥è·³è¿‡å»çœ‹çœ‹ï¼Œä¹ŸæŒºä¸é”™çš„ï¼š</p>
<p><a target="_blank" rel="noopener" href="https://www.joxrays.com/frp-source-code/">https://www.joxrays.com/frp-source-code/</a></p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">ğŸ“„é¦–é¡µ</a></li>
        
          <li><a href="/archives/">ğŸ“‚å½’æ¡£</a></li>
        
          <li><a href="/friends/">ğŸ‘«å‹é“¾</a></li>
        
          <li><a href="/categories/">ğŸ—‚ï¸åˆ†ç±»</a></li>
        
          <li><a href="/tags/">ğŸ·ï¸æ ‡ç­¾</a></li>
        
          <li><a href="/about/">ğŸŒ¸å…³äº</a></li>
        
          <li><a href="/log/">ğŸ“–æ—¥å¿—</a></li>
        
          <li><a href="/search/">ğŸ”æœç´¢</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#v0-1-0-%E7%89%88%E6%9C%AC"><span class="toc-number">1.</span> <span class="toc-text">v0.1.0 ç‰ˆæœ¬</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#frps"><span class="toc-number">1.1.</span> <span class="toc-text">frps</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#frpc"><span class="toc-number">1.2.</span> <span class="toc-text">frpc</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%8E%E8%AF%9D"><span class="toc-number">2.</span> <span class="toc-text">åè¯</span></a></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://blog.kinoko.fun/2024/06/01/frp-read/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://blog.kinoko.fun/2024/06/01/frp-read/&text=FRPv0.1.0 æºç é˜…è¯»"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://blog.kinoko.fun/2024/06/01/frp-read/&title=FRPv0.1.0 æºç é˜…è¯»"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://blog.kinoko.fun/2024/06/01/frp-read/&is_video=false&description=FRPv0.1.0 æºç é˜…è¯»"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=FRPv0.1.0 æºç é˜…è¯»&body=Check out this article: https://blog.kinoko.fun/2024/06/01/frp-read/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://blog.kinoko.fun/2024/06/01/frp-read/&title=FRPv0.1.0 æºç é˜…è¯»"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://blog.kinoko.fun/2024/06/01/frp-read/&title=FRPv0.1.0 æºç é˜…è¯»"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://blog.kinoko.fun/2024/06/01/frp-read/&title=FRPv0.1.0 æºç é˜…è¯»"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://blog.kinoko.fun/2024/06/01/frp-read/&title=FRPv0.1.0 æºç é˜…è¯»"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://blog.kinoko.fun/2024/06/01/frp-read/&name=FRPv0.1.0 æºç é˜…è¯»&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://blog.kinoko.fun/2024/06/01/frp-read/&t=FRPv0.1.0 æºç é˜…è¯»"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> èœå•</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> ç›®å½•</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> åˆ†äº«</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> è¿”å›é¡¶éƒ¨</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    <div class="footer-cnrecord">
      <img id="gongan" alt class="gongan-logo"
          src="/images/gongan.png" />
      æµ™ICPå¤‡2023028448å·-2
    </div>
    <div class="footer-copyright">
      Copyright &copy;
      
      
      2022-2025
      é˜¿è‡kinoko
    </div>
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">ğŸ“„é¦–é¡µ</a></li><!--
     --><!--
       --><li><a href="/archives/">ğŸ“‚å½’æ¡£</a></li><!--
     --><!--
       --><li><a href="/friends/">ğŸ‘«å‹é“¾</a></li><!--
     --><!--
       --><li><a href="/categories/">ğŸ—‚ï¸åˆ†ç±»</a></li><!--
     --><!--
       --><li><a href="/tags/">ğŸ·ï¸æ ‡ç­¾</a></li><!--
     --><!--
       --><li><a href="/about/">ğŸŒ¸å…³äº</a></li><!--
     --><!--
       --><li><a href="/log/">ğŸ“–æ—¥å¿—</a></li><!--
     --><!--
       --><li><a href="/search/">ğŸ”æœç´¢</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"å¤åˆ¶åˆ°ç²˜è´´æ¿ï¼\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "å¤åˆ¶æˆåŠŸï¼");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
